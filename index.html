<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Archive</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fff; margin: 10% auto; padding: 25px;
            border-radius: 15px; width: 90%; max-width: 400px; font-family: sans-serif;
        }
        .modal-content h3 { margin-top: 0; color: #333; }
        .modal-content input, .modal-content textarea {
            width: 100%; margin-bottom: 15px; padding: 10px;
            box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px;
        }
        .modal-content button {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; margin-bottom: 5px;
        }
        .btn-save { background-color: #333; color: white; }
        .btn-cancel { background-color: #eee; color: #666; }
        .profile-img { cursor: pointer; transition: opacity 0.3s; }
        .profile-img:hover { opacity: 0.8; }
        .edit-hint { font-size: 0.7rem; color: #999; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile">
            <img src="images/KakaoTalk_20240406_232152395.jpg" alt="í”„ë¡œí•„ ì‚¬ì§„" class="profile-img" id="displayProfileImg" onclick="openProfileEdit()">
            <h2 id="displayName" onclick="openProfileEdit()">Hamihamoo</h2>
            <p id="displayDescription" onclick="openProfileEdit()">Amateur Photographer</p>
            <div class="edit-hint" onclick="openProfileEdit()">[ í”„ë¡œí•„ ìˆ˜ì •í•˜ê¸° ]</div>
            
            <nav>
                <ul>
                    <li><a href="digital.html">Digital Photos</a></li>
                    <li><a href="film.html">Film Photos</a></li>
                </ul>
            </nav>
        </div>

        <div class="main-content">
            <h1>Photo Archive</h1>
            <p>Hi! This is my personal Photo Archive.</p>
        </div>
    </div>

    <div id="profileModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ‘¤ í”„ë¡œí•„ ìˆ˜ì •</h3>
            <input type="password" id="profileToken" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
            
            <label style="font-size: 0.8rem; display: block; margin-bottom: 5px;">ğŸ“¸ ìƒˆ í”„ë¡œí•„ ì‚¬ì§„ (ì„ íƒì‚¬í•­)</label>
            <input type="file" id="profileFile" accept="image/*">
            
            <label style="font-size: 0.8rem; display: block; margin-bottom: 5px;">ì´ë¦„</label>
            <input type="text" id="editName" placeholder="ì´ë¦„">
            
            <label style="font-size: 0.8rem; display: block; margin-bottom: 5px;">ìê¸°ì†Œê°œ</label>
            <textarea id="editDescription" rows="3" placeholder="ìê¸°ì†Œê°œ"></textarea>
            
            <button class="btn-save" onclick="saveProfile()">ì €ì¥í•˜ê¸°</button>
            <button class="btn-cancel" onclick="closeProfileEdit()">ì·¨ì†Œ</button>
            <div id="uploadStatus" style="font-size: 0.8rem; text-align: center; margin-top: 10px; color: blue;"></div>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ profile.jsonì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadProfile() {
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/profile.json`);
                if (res.ok) {
                    const data = await res.json();
                    const profile = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                    
                    if(profile.profileImage) document.getElementById('displayProfileImg').src = profile.profileImage + "?v=" + Date.now();
                    if(profile.name) document.getElementById('displayName').innerText = profile.name;
                    if(profile.description) document.getElementById('displayDescription').innerText = profile.description;
                    
                    // ìˆ˜ì •ì°½ì—ë„ ë¯¸ë¦¬ ì±„ì›Œë„£ê¸°
                    document.getElementById('editName').value = profile.name || "Hamihamoo";
                    document.getElementById('editDescription').value = profile.description || "Amateur Photographer";
                }
            } catch (e) { console.log("ê¸°ì¡´ í”„ë¡œí•„ì´ ì—†ê±°ë‚˜ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
        }

        function openProfileEdit() { document.getElementById('profileModal').style.display = 'block'; }
        function closeProfileEdit() { document.getElementById('profileModal').style.display = 'none'; }

        // 2. í”„ë¡œí•„ ì €ì¥ ë¡œì§
        async function saveProfile() {
            const token = document.getElementById('profileToken').value;
            const fileInput = document.getElementById('profileFile');
            const newName = document.getElementById('editName').value;
            const newDesc = document.getElementById('editDescription').value;
            const status = document.getElementById('uploadStatus');

            if (!token) return alert("ìˆ˜ì •í•˜ë ¤ë©´ ê¹ƒí—ˆë¸Œ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            status.innerText = "â³ ì²˜ë¦¬ ì¤‘...";

            try {
                let currentImgPath = document.getElementById('displayProfileImg').src.split('?')[0];
                // ì ˆëŒ€ê²½ë¡œì¼ ê²½ìš° ìƒëŒ€ê²½ë¡œë¡œ ë³€í™˜
                if(currentImgPath.includes('images/')) {
                    currentImgPath = "images/" + currentImgPath.split('images/')[1];
                }

                // ì‚¬ì§„ì„ ìƒˆë¡œ ì„ íƒí•œ ê²½ìš° ì—…ë¡œë“œ
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const base64 = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(file);
                    });
                    
                    const fileName = "profile_" + Date.now() + ".jpg";
                    const newPath = "images/" + fileName;

                    await fetch(`https://api.github.com/repos/${repo}/contents/${newPath}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: "Update profile image", content: base64 })
                    });
                    currentImgPath = newPath;
                }

                // profile.json ì—…ë°ì´íŠ¸
                const profileData = { profileImage: currentImgPath, name: newName, description: newDesc };
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/profile.json`, {
                    headers: { "Authorization": `token ${token}` }
                });
                
                let sha = "";
                if (res.ok) {
                    const existingJson = await res.json();
                    sha = existingJson.sha;
                }

                const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/profile.json`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}` },
                    body: JSON.stringify({
                        message: "Update profile info",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(profileData, null, 2)))),
                        sha: sha
                    })
                });

                if(putRes.ok) {
                    alert("âœ… í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.reload();
                } else { throw new Error("JSON ì €ì¥ ì‹¤íŒ¨"); }

            } catch (e) {
                alert("âŒ ì‹¤íŒ¨: " + e.message);
                status.innerText = "";
            }
        }

        window.onload = loadProfile;
    </script>
</body>
</html>
