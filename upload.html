<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ì—…ë¡œë“œ/ìˆ˜ì •/ì‚­ì œ)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; }
        .info-msg { font-size: 0.8rem; color: #666; margin-bottom: 10px; text-align: center; }
        .color-preview { height: 25px; border-radius: 5px; margin-bottom: 10px; display: none; text-align: center; color: white; font-size: 0.85rem; line-height: 25px; font-weight: bold; }
        .manage-section { max-width: 600px; margin: 50px auto; font-family: sans-serif; }
        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-bottom: 0; }
        .edit-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .refresh-btn { background-color: #007bff; margin-bottom: 20px; }
        /* ìë™ ë¶„ì„ ë²„íŠ¼ ì „ìš© ìƒ‰ìƒ */
        .auto-btn { background-color: #6f42c1; margin-bottom: 20px; margin-left: 5px; }
        .auto-btn:hover { background-color: #59359a; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ìƒˆ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h2>
        <p class="info-msg">ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ EXIF ì •ë³´ì™€ í…Œë§ˆ ìƒ‰ìƒì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        <input type="file" id="fileInput" accept="image/*">
        <div id="colorPreview" class="color-preview"></div>
        <textarea id="photoInfo" rows="3" placeholder="ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤."></textarea>
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ê´€ë¦¬</h2>
        <div style="display: flex;">
            <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="refresh-btn auto-btn" onclick="autoAnalyzeExistingPhotos()">âš¡ ê¸°ì¡´ ì‚¬ì§„ ìƒ‰ìƒ ìë™ ë¶„ì„</button>
        </div>
        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ [ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        let detectedColor = "None";
        const repo = "Helios0513/Photo_Archive.github.io";

        // [í•¨ìˆ˜ 1] ìƒ‰ìƒ ë¶„ì„ ë¡œì§
        function analyzeColor(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 50; canvas.height = 50;
            ctx.drawImage(img, 0, 0, 50, 50);
            const data = ctx.getImageData(0, 0, 50, 50).data;
            let r=0, g=0, b=0;
            for(let i=0; i<data.length; i+=4) { r += data[i]; g += data[i+1]; b += data[i+2]; }
            r = Math.floor(r/(data.length/4)); g = Math.floor(g/(data.length/4)); b = Math.floor(b/(data.length/4));
            const hsp = Math.sqrt(0.299*(r*r) + 0.587*(g*g) + 0.114*(b*b));
            if (hsp > 200) return "White";
            if (hsp < 50) return "Black";
            const max = Math.max(r, g, b);
            if (max - Math.min(r, g, b) < 20) return "Gray";
            if (max === r) return "Red";
            if (max === g) return "Green";
            return "Blue";
        }

        // [í•¨ìˆ˜ 2] íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('status');
            status.innerText = "ğŸ” ë¶„ì„ ì¤‘...";
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    detectedColor = analyzeColor(img);
                    const cp = document.getElementById('colorPreview');
                    cp.style.display = 'block';
                    cp.style.backgroundColor = detectedColor.toLowerCase();
                    cp.style.color = (detectedColor === "White" || detectedColor === "Gray") ? "black" : "white";
                    cp.innerText = `ë¶„ì„ëœ í…Œë§ˆ ìƒ‰ìƒ: ${detectedColor}`;
                    EXIF.getData(file, function() {
                        const model = EXIF.getTag(this, "Model") || "Unknown Camera";
                        const fl = EXIF.getTag(this, "FocalLength");
                        const fn = EXIF.getTag(this, "FNumber");
                        const et = EXIF.getTag(this, "ExposureTime");
                        const iso = EXIF.getTag(this, "ISOSpeedRatings");
                        const focal = fl ? Math.round(fl) + "mm" : "";
                        let shutter = et < 1 ? `1/${Math.round(1/et)}` : (et ? Math.round(et * 10) / 10 : "");
                        const fVal = fn ? `f${Math.round(fn * 10) / 10}` : "";
                        document.getElementById('photoInfo').value = `${model} ${focal} ${fVal}, ${shutter}s iso ${iso}`;
                        status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ";
                    });
                };
            };
            reader.readAsDataURL(file);
        });

        // [í•¨ìˆ˜ 3] ì‚¬ì§„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "<p style='text-align:center;'>ë¡œë”© ì¤‘...</p>";
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                if (!res.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
                const data = await res.json();
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                renderList();
            } catch (e) { listDiv.innerHTML = "âŒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + e.message; }
        }

        // ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ ë¶„ë¦¬
        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="images/digital/${p.filename}" onerror="this.src='https://via.placeholder.com/80x60'">
                    <div class="photo-info-edit">
                        <input type="text" id="edit-info-${realIndex}" value="${p.info}">
                        <small>${p.filename} | <b>${p.color || '<span style="color:red">ìƒ‰ìƒ ì—†ìŒ</span>'}</b></small>
                    </div>
                    <div class="btn-group">
                        <button class="edit-btn" onclick="updateInfo(${realIndex})">ìˆ˜ì •</button>
                        <button class="delete-btn" onclick="deletePhoto(${realIndex}, '${p.filename}')">ì‚­ì œ</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        // [ì‹ ê·œ ê¸°ëŠ¥] ê¸°ì¡´ ì‚¬ì§„ ìë™ ë¶„ì„
        async function autoAnalyzeExistingPhotos() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            if (!window.allPhotos) return alert("ë¨¼ì € [ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!");

            const status = document.getElementById('status');
            let updatedCount = 0;
            status.innerText = "â³ ê¸°ì¡´ ì‚¬ì§„ ìƒ‰ìƒ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤ (ë¸Œë¼ìš°ì € ì„±ëŠ¥ì— ë”°ë¼ ìˆ˜ì‹­ ì´ˆ ì†Œìš”)...";

            for (let photo of window.allPhotos) {
                // ìƒ‰ìƒì´ ì—†ê±°ë‚˜ Noneì¸ ê²ƒë§Œ ë¶„ì„
                if (!photo.color || photo.color === "None") {
                    try {
                        status.innerText = `ğŸ” ë¶„ì„ ì¤‘: ${photo.filename}`;
                        const img = new Image();
                        img.crossOrigin = "Anonymous"; // ê¹ƒí—ˆë¸Œ í˜ì´ì§€ ì„¤ì •ì— ë”°ë¼ í•„ìš”í•  ìˆ˜ ìˆìŒ
                        img.src = `https://helios0513.github.io/Photo_Archive.github.io/images/digital/${photo.filename}`;
                        
                        await new Promise((resolve) => {
                            img.onload = () => {
                                photo.color = analyzeColor(img);
                                updatedCount++;
                                resolve();
                            };
                            img.onerror = () => {
                                console.log(photo.filename + " ë¶„ì„ ê±´ë„ˆëœ€ (ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨)");
                                resolve();
                            };
                        });
                    } catch (e) { console.error(e); }
                }
            }

            if (updatedCount > 0) {
                status.innerText = `ğŸ’¾ ${updatedCount}ê°œ ë¶„ì„ ì™„ë£Œ! ì¥ë¶€ ì—…ë°ì´íŠ¸ ì¤‘...`;
                await saveJson(token, `Batch analyze ${updatedCount} colors`, window.allPhotos);
                status.innerText = `âœ… ì´ ${updatedCount}ê°œì˜ ì‚¬ì§„ ìƒ‰ìƒì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤!`;
                renderList();
            } else {
                status.innerText = "âœ… ëª¨ë“  ì‚¬ì§„ì— ì´ë¯¸ ìƒ‰ìƒ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤.";
            }
        }

        // [í•¨ìˆ˜ 4] ì €ì¥/ìˆ˜ì •/ì‚­ì œ ë¡œì§
        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { headers: { "Authorization": `token ${token}` } });
            const fileData = await res.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
        }

        async function updateInfo(index) {
            const token = document.getElementById('token').value;
            const newInfo = document.getElementById(`edit-info-${index}`).value;
            if(!confirm("ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            window.allPhotos[index].info = newInfo;
            await saveJson(token, "Update info", window.allPhotos);
            alert("ìˆ˜ì • ì™„ë£Œ!");
            loadPhotoList();
        }

        async function deletePhoto(index, fileName) {
            const token = document.getElementById('token').value;
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            window.allPhotos.splice(index, 1);
            await saveJson(token, `Delete ${fileName}`, window.allPhotos);
            try {
                const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, { headers: { "Authorization": `token ${token}` } });
                const fileData = await fileRes.json();
                await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                    method: "DELETE",
                    headers: { "Authorization": `token ${token}` },
                    body: JSON.stringify({ message: `Delete ${fileName}`, sha: fileData.sha })
                });
            } catch(e) { }
            alert("ì‚­ì œ ì™„ë£Œ!");
            loadPhotoList();
        }

        // [í•¨ìˆ˜ 5] ì—…ë¡œë“œ ë©”ì¸ ë¡œì§
        async function handleUpload() {
            const token = document.getElementById('token').value;
            const fileInput = document.getElementById('fileInput').files[0];
            const info = document.getElementById('photoInfo').value;
            const status = document.getElementById('status');
            if (!token || !fileInput) return alert("í† í°ê³¼ ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
            status.innerText = "â³ ì‚¬ì§„ ìµœì í™” ì¤‘...";
            try {
                const optimizedBlob = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.readAsDataURL(fileInput);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > 1920) { h = (1920 * h) / w; w = 1920; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
                        };
                    };
                });
                const reader = new FileReader();
                reader.readAsDataURL(optimizedBlob);
                reader.onload = async () => {
                    const content = reader.result.split(',')[1];
                    const fileName = fileInput.name.replace(/\.[^/.]+$/, "") + ".jpg";
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Upload: ${fileName}`, content: content })
                    });
                    const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { headers: { "Authorization": `token ${token}` } });
                    const fileData = await res.json();
                    const photos = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                    photos.push({ filename: fileName, info: info, color: detectedColor });
                    await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({
                            message: `Add ${fileName}`,
                            content: btoa(unescape(encodeURIComponent(JSON.stringify(photos, null, 2)))),
                            sha: fileData.sha
                        })
                    });
                    status.innerText = "âœ… ì„±ê³µ! 1ë¶„ ë’¤ ë°˜ì˜ë©ë‹ˆë‹¤.";
                    loadPhotoList();
                };
            } catch (e) { status.innerText = "âŒ ì‹¤íŒ¨: " + e.message; }
        }
    </script>
</body>
</html>
