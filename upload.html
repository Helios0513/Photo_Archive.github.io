<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ì¼ê´„ ì„ íƒ ìˆ˜ì •)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; display: block; font-weight: bold; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem; }
        
        .manage-section { max-width: 650px; margin: 50px auto; font-family: sans-serif; }
        
        /* âœ¨ ì¼ê´„ ì„ íƒ ë„êµ¬ ë°” */
        .selection-tool-bar {
            position: sticky; top: 10px; z-index: 100;
            background: #eef2ff; padding: 15px; border: 2px solid #4f46e5; 
            border-radius: 10px; margin-bottom: 20px; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tool-row { display: flex; gap: 10px; align-items: center; margin-top: 10px; }
        .tool-row input[type="date"] { margin-bottom: 0; flex: 2; }
        .apply-btn { background-color: #4f46e5; margin: 0; flex: 1; white-space: nowrap; }
        .save-final-btn { background-color: #059669; margin-top: 10px; width: 100%; }

        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item.selected { background-color: #f5f7ff; border-color: #4f46e5; }
        .photo-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .refresh-btn { background-color: #6366f1; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ìƒˆ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h2>
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        <input type="file" id="fileInput" accept="image/*">
        <label>ğŸ“… ì´¬ì˜ ë‚ ì§œ</label>
        <input type="date" id="photoDate">
        <textarea id="photoInfo" rows="2" placeholder="ì‚¬ì§„ ì„¤ëª…"></textarea>
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ì¼ê´„ ê´€ë¦¬</h2>
        <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        
        <div id="selectionTool" class="selection-tool-bar">
            <div style="font-size: 0.85rem; color: #4338ca;"><strong>âœ… ì„ íƒ ìˆ˜ì • ëª¨ë“œ</strong> (ì‚¬ì§„ì„ ì²´í¬í•œ ë’¤ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”)</div>
            <div class="tool-row">
                <input type="date" id="batchDateInput">
                <button class="apply-btn" onclick="applyDateToSelected()">ì„ íƒ í•­ëª©ì— ë‚ ì§œ ì ìš©</button>
            </div>
            <button class="save-final-btn" onclick="saveAllChanges()">ğŸ’¾ ë³€ê²½ì‚¬í•­ ìµœì¢… ì €ì¥í•˜ê¸°</button>
        </div>

        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                const data = await res.json();
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                document.getElementById('selectionTool').style.display = 'block';
                renderList();
            } catch (e) { alert("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.id = `item-${realIndex}`;
                item.innerHTML = `
                    <input type="checkbox" class="photo-check" data-index="${realIndex}" onchange="toggleHighlight(${realIndex})">
                    <img src="images/digital/${p.filename}">
                    <div class="photo-info-edit">
                        <input type="date" class="edit-date" id="date-${realIndex}" value="${p.date || ''}">
                        <input type="text" class="edit-info" id="info-${realIndex}" value="${p.info}">
                        <small style="color:#aaa">${p.filename}</small>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        // ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ ë°°ê²½ìƒ‰ ê°•ì¡°
        function toggleHighlight(idx) {
            document.getElementById(`item-${idx}`).classList.toggle('selected');
        }

        // âœ¨ í•µì‹¬ ê¸°ëŠ¥: ì„ íƒëœ í•­ëª©ì— ë‚ ì§œ í•œêº¼ë²ˆì— ì±„ìš°ê¸°
        function applyDateToSelected() {
            const batchDate = document.getElementById('batchDateInput').value;
            if (!batchDate) return alert("ì ìš©í•  ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
            
            const checkboxes = document.querySelectorAll('.photo-check:checked');
            if (checkboxes.length === 0) return alert("ë‚ ì§œë¥¼ ì ìš©í•  ì‚¬ì§„ì„ ë¨¼ì € ì²´í¬í•´ ì£¼ì„¸ìš”.");

            checkboxes.forEach(cb => {
                const idx = cb.getAttribute('data-index');
                const dateInput = document.getElementById(`date-${idx}`);
                dateInput.value = batchDate;
                dateInput.style.backgroundColor = "#eef2ff"; // ë°”ë€ í‘œì‹œ
            });
            
            alert(`${checkboxes.length}ê°œì˜ ì‚¬ì§„ì— ë‚ ì§œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ê¼­ í•˜ë‹¨ì˜ ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!`);
        }

        // ìµœì¢… ì €ì¥
        async function saveAllChanges() {
            const token = document.getElementById('token').value;
            if(!confirm("ëª¨ë“  ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            window.allPhotos.forEach((p, idx) => {
                p.date = document.getElementById(`date-${idx}`).value;
                p.info = document.getElementById(`info-${idx}`).value;
            });

            try {
                document.getElementById('status').innerText = "â³ ê¹ƒí—ˆë¸Œ ì €ì¥ ì¤‘...";
                await saveJson(token, "Update photo metadata", window.allPhotos);
                alert("ì €ì¥ ì™„ë£Œ!");
                loadPhotoList();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        }

        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                headers: { "Authorization": `token ${token}` } 
            });
            const fileData = await res.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
        }

        // (ê¸°ë³¸ ì—…ë¡œë“œ handleUpload ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼)
    </script>
</body>
</html>
