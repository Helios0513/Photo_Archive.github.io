<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ë‹¤ì¤‘ ì—…ë¡œë“œ ë° ì¼ê´„ ë³µêµ¬)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; display: block; font-weight: bold; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem; }
        
        .manage-section { max-width: 600px; margin: 50px auto; font-family: sans-serif; }
        
        .batch-tool-box { 
            background: #fff4e5; padding: 15px; border: 2px solid #ff9800; 
            border-radius: 10px; margin-bottom: 20px; display: none;
        }
        .batch-tool-box h3 { margin-top: 0; font-size: 1rem; color: #e65100; }
        .magic-btn { background-color: #ff9800; margin-top: 5px; }
        .save-all-btn { background-color: #28a745; margin-top: 10px; }

        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #f9f9f9; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .delete-btn { background-color: #dc3545; width: auto; padding: 6px 12px; font-size: 0.75rem; }
        .refresh-btn { background-color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ì‚¬ì§„ ì˜¬ë¦¬ê¸° (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</h2>
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        
        <label>ğŸ“· ì‚¬ì§„ ì„ íƒ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</label>
        <input type="file" id="fileInput" accept="image/*" multiple>
        
        <p class="info-msg" style="font-size: 0.8rem; color: #666; text-align: center;">
            â€» ì—¬ëŸ¬ ì¥ ì—…ë¡œë“œ ì‹œ, ê° ì‚¬ì§„ì˜ ë©”íƒ€ë°ì´í„° ë‚ ì§œë¡œ ìë™ ì €ì¥ë©ë‹ˆë‹¤.
        </p>
        
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ê´€ë¦¬ ë° ë³µêµ¬</h2>
        <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        
        <div id="batchTool" class="batch-tool-box">
            <h3>ğŸ›  ì¼ê´„ ë‚ ì§œ ë³µêµ¬ ë„êµ¬</h3>
            <p style="font-size: 0.8rem; color: #666;">
                ë‚ ì§œê°€ ì—†ëŠ” ê¸°ì¡´ ì‚¬ì§„ë“¤ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ë‚ ì§œë¥¼ ì±„ì›ë‹ˆë‹¤.
            </p>
            <button class="magic-btn" onclick="autoFillDates()">ğŸª„ ê¸°ì¡´ ì‚¬ì§„ ë‚ ì§œ ì¼ê´„ ì¶”ì¶œí•˜ê¸°</button>
            <button class="save-all-btn" onclick="saveAllChanges()">âœ… ë³€ê²½ëœ ëª¨ë“  ë‚´ìš© ì €ì¥í•˜ê¸°</button>
        </div>

        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        // [1] ëª©ë¡ ë¡œë“œ
        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                const data = await res.json();
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                document.getElementById('batchTool').style.display = 'block';
                renderList();
            } catch (e) { alert("ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="images/digital/${p.filename}" id="img-${realIndex}">
                    <div class="photo-info-edit">
                        <input type="date" class="edit-date" data-index="${realIndex}" value="${p.date || ''}">
                        <input type="text" class="edit-info" data-index="${realIndex}" value="${p.info}">
                        <small>${p.filename}</small>
                    </div>
                    <button class="delete-btn" onclick="deletePhoto(${realIndex}, '${p.filename}')">ì‚­ì œ</button>
                `;
                listDiv.appendChild(item);
            });
        }

        // [2] ì¼ê´„ ë‚ ì§œ ì¶”ì¶œ ê¸°ëŠ¥
        async function autoFillDates() {
            const status = document.getElementById('status');
            const dateInputs = document.querySelectorAll('.edit-date');
            let count = 0;
            status.innerText = "â³ ê¸°ì¡´ ì‚¬ì§„ ë¶„ì„ ì‹œì‘...";
            for (let input of dateInputs) {
                if (!input.value) {
                    const idx = input.getAttribute('data-index');
                    const fileName = window.allPhotos[idx].filename;
                    const imgUrl = `images/digital/${fileName}`;
                    try {
                        const response = await fetch(imgUrl);
                        const blob = await response.blob();
                        await new Promise((resolve) => {
                            EXIF.getData(blob, function() {
                                const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                                if (exifDate) {
                                    const parts = exifDate.split(" ")[0].split(":");
                                    input.value = `${parts[0]}-${parts[1]}-${parts[2]}`;
                                    input.style.border = "2px solid #ff9800";
                                    count++;
                                }
                                resolve();
                            });
                        });
                    } catch (err) { console.log(err); }
                }
            }
            status.innerText = `âœ… ë¶„ì„ ì™„ë£Œ! ${count}ê°œì˜ ë‚ ì§œ ë³µêµ¬. [ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
        }

        // [3] ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ë¡œì§ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
        async function handleUpload() {
            const token = document.getElementById('token').value;
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            const files = fileInput.files;

            if (!token || files.length === 0) return alert("í† í°ê³¼ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");

            status.innerText = `â³ ì´ ${files.length}ì¥ì˜ ì‚¬ì§„ ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...`;

            try {
                // 1. ìµœì‹  photos.json ê°€ì ¸ì˜¤ê¸°
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                const fileData = await res.json();
                let photos = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

                // 2. íŒŒì¼ë³„ë¡œ ë£¨í”„ ëŒë©° ì²˜ë¦¬
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    status.innerText = `ğŸ“¤ ì—…ë¡œë“œ ì¤‘ (${i + 1}/${files.length}): ${file.name}`;

                    // EXIF ë°ì´í„° ì¶”ì¶œ (ë‚ ì§œ & ì •ë³´)
                    const exifData = await new Promise(resolve => {
                        EXIF.getData(file, function() {
                            const date = EXIF.getTag(this, "DateTimeOriginal");
                            const model = EXIF.getTag(this, "Model") || "";
                            const fNum = EXIF.getTag(this, "FNumber") ? `f${EXIF.getTag(this, "FNumber")}` : "";
                            const iso = EXIF.getTag(this, "ISOSpeedRatings") ? `iso ${EXIF.getTag(this, "ISOSpeedRatings")}` : "";
                            
                            let formattedDate = new Date().toISOString().substring(0, 10);
                            if (date) {
                                const p = date.split(" ")[0].split(":");
                                formattedDate = `${p[0]}-${p[1]}-${p[2]}`;
                            }
                            resolve({ date: formattedDate, info: `${model} ${fNum} ${iso}`.trim() });
                        });
                    });

                    // ì´ë¯¸ì§€ ìµœì í™” (1920px)
                    const optimizedBlob = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (e) => {
                            const img = new Image();
                            img.src = e.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let w = img.width, h = img.height;
                                if (w > 1920) { h = (1920 * h) / w; w = 1920; }
                                canvas.width = w; canvas.height = h;
                                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
                            };
                        };
                    });

                    // ê¹ƒí—ˆë¸Œì— ì´ë¯¸ì§€ íŒŒì¼ ì „ì†¡
                    const base64Content = await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.readAsDataURL(optimizedBlob);
                        reader.onload = () => resolve(reader.result.split(',')[1]);
                    });

                    const fileName = file.name.replace(/\.[^/.]+$/, "") + "_" + Date.now() + ".jpg";
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Upload: ${fileName}`, content: base64Content })
                    });

                    // ë¦¬ìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
                    photos.push({ filename: fileName, info: exifData.info, date: exifData.date });
                }

                // 3. ìµœì¢… JSON ì—…ë°ì´íŠ¸ (í•œ ë²ˆë§Œ)
                status.innerText = "ğŸ’¾ ì¥ë¶€ ì—…ë°ì´íŠ¸ ì¤‘...";
                await saveJson(token, `Batch upload ${files.length} photos`, photos);
                
                status.innerText = `âœ… ì´ ${files.length}ì¥ ì—…ë¡œë“œ ì™„ë£Œ!`;
                fileInput.value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
                loadPhotoList();

            } catch (e) {
                status.innerText = "âŒ ì‹¤íŒ¨: " + e.message;
            }
        }

        // [4] ì¼ê´„ ì €ì¥ ë° ì‚­ì œ (ê¸°ì¡´ ìœ ì§€)
        async function saveAllChanges() {
            const token = document.getElementById('token').value;
            const dateInputs = document.querySelectorAll('.edit-date');
            const infoInputs = document.querySelectorAll('.edit-info');
            dateInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].date = input.value;
            });
            infoInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].info = input.value;
            });
            try {
                await saveJson(token, "Batch update metadata", window.allPhotos);
                alert("ì €ì¥ ì„±ê³µ!");
                loadPhotoList();
            } catch(e) { alert("ì‹¤íŒ¨"); }
        }

        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                headers: { "Authorization": `token ${token}` } 
            });
            const fileData = await res.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
        }

        async function deletePhoto(index, fileName) {
            const token = document.getElementById('token').value;
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const photos = [...window.allPhotos];
            photos.splice(index, 1);
            try {
                await saveJson(token, `Delete ${fileName}`, photos);
                const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                if (fileRes.ok) {
                    const fData = await fileRes.json();
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "DELETE",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Delete file`, sha: fData.sha })
                    });
                }
                loadPhotoList();
            } catch(e) { alert("ì˜¤ë¥˜"); }
        }
    </script>
</body>
</html>
