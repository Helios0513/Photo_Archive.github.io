<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ê³¼ê±° ë‚ ì§œ ìˆ˜ì • ê¸°ëŠ¥)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; display: block; font-weight: bold; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; }
        .info-msg { font-size: 0.8rem; color: #666; margin-bottom: 15px; text-align: center; }
        
        /* ê´€ë¦¬ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .manage-section { max-width: 600px; margin: 50px auto; font-family: sans-serif; }
        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #f9f9f9; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-bottom: 0; }
        .edit-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .refresh-btn { background-color: #007bff; margin-bottom: 20px; width: 100%; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ìƒˆ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h2>
        <p class="info-msg">ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ ì´¬ì˜ ì •ë³´ì™€ ë‚ ì§œë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
        
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        <input type="file" id="fileInput" accept="image/*">
        
        <label for="photoDate">ğŸ“… ì´¬ì˜ ë‚ ì§œ í™•ì¸/ìˆ˜ì •</label>
        <input type="date" id="photoDate">
        
        <label for="photoInfo">ğŸ“ ì‚¬ì§„ ìƒì„¸ ì •ë³´</label>
        <textarea id="photoInfo" rows="3" placeholder="ì¹´ë©”ë¼ ì •ë³´ê°€ ì—¬ê¸°ì— ì…ë ¥ë©ë‹ˆë‹¤."></textarea>
        
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ê´€ë¦¬ (ë‚ ì§œ ìˆ˜ì •)</h2>
        <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° / ìƒˆë¡œê³ ì¹¨</button>
        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ [ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        // [1] EXIF ë°ì´í„° ì¶”ì¶œ ë¡œì§
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const status = document.getElementById('status');
            status.innerText = "ğŸ” ì´¬ì˜ ë‚ ì§œ ë° ì •ë³´ ë¶„ì„ ì¤‘...";
            
            EXIF.getData(file, function() {
                const model = EXIF.getTag(this, "Model") || "Unknown Camera";
                const fl = EXIF.getTag(this, "FocalLength");
                const fn = EXIF.getTag(this, "FNumber");
                const et = EXIF.getTag(this, "ExposureTime");
                const iso = EXIF.getTag(this, "ISOSpeedRatings");
                const focal = fl ? Math.round(fl) + "mm" : "";
                let shutter = et < 1 ? `1/${Math.round(1/et)}` : (et ? Math.round(et * 10) / 10 : "");
                const fVal = fn ? `f${Math.round(fn * 10) / 10}` : "";
                
                document.getElementById('photoInfo').value = `${model} ${focal} ${fVal}, ${shutter}s iso ${iso}`;

                const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                const dateInput = document.getElementById('photoDate');
                
                if (exifDate) {
                    const parts = exifDate.split(" ")[0].split(":");
                    dateInput.value = `${parts[0]}-${parts[1]}-${parts[2]}`;
                } else {
                    dateInput.value = new Date().toISOString().substring(0, 10);
                }
                status.innerText = "âœ… ì •ë³´ ë¶„ì„ ì™„ë£Œ (ë‚ ì§œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”)";
            });
        });

        // [2] ì‚¬ì§„ ëª©ë¡ ë¡œë“œ ë° ë Œë”ë§
        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "<p style='text-align:center;'>ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>";
            
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                if (!res.ok) throw new Error("ì¥ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                const data = await res.json();
                // ê¹ƒí—ˆë¸Œ APIì˜ base64 ë””ì½”ë”© ì²˜ë¦¬
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                renderList();
            } catch (e) { listDiv.innerHTML = "âŒ ë¡œë“œ ì‹¤íŒ¨: " + e.message; }
        }

        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            // ìµœì‹  ì‚¬ì§„ì´ ìœ„ë¡œ ì˜¤ê²Œ ì—­ìˆœ ì¶œë ¥
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="images/digital/${p.filename}" alt="">
                    <div class="photo-info-edit">
                        <label style="font-size:0.7rem; color:#888;">ë‚ ì§œ ìˆ˜ì •:</label>
                        <input type="date" id="edit-date-${realIndex}" value="${p.date || ''}">
                        <input type="text" id="edit-info-${realIndex}" value="${p.info}">
                        <small style="color:#bbb;">${p.filename}</small>
                    </div>
                    <div class="btn-group">
                        <button class="edit-btn" onclick="updateInfo(${realIndex})">ì €ì¥</button>
                        <button class="delete-btn" onclick="deletePhoto(${realIndex}, '${p.filename}')">ì‚­ì œ</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        // [3] ê³µí†µ JSON ì €ì¥ ë¡œì§ (SHA ìë™ ê°±ì‹ )
        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                headers: { "Authorization": `token ${token}` } 
            });
            const fileData = await res.json();
            
            const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
            if (!putRes.ok) throw new Error("JSON ì €ì¥ ì‹¤íŒ¨");
        }

        // [4] ê°œë³„ ì •ë³´ ìˆ˜ì • ì €ì¥ (ë‚ ì§œ í¬í•¨)
        async function updateInfo(index) {
            const token = document.getElementById('token').value;
            const newInfo = document.getElementById(`edit-info-${index}`).value;
            const newDate = document.getElementById(`edit-date-${index}`).value;
            
            if(!confirm("í•´ë‹¹ ì‚¬ì§„ì˜ ë‚ ì§œì™€ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            // ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸
            window.allPhotos[index].info = newInfo;
            window.allPhotos[index].date = newDate;
            
            try {
                await saveJson(token, `Update info/date for ${window.allPhotos[index].filename}`, window.allPhotos);
                alert("ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadPhotoList();
            } catch(e) { alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message); }
        }

        // [5] ì‚¬ì§„ ì‚­ì œ ë¡œì§
        async function deletePhoto(index, fileName) {
            const token = document.getElementById('token').value;
            if(!confirm("ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            const targetPhoto = window.allPhotos[index];
            window.allPhotos.splice(index, 1);
            
            try {
                // 1. JSON ì—…ë°ì´íŠ¸
                await saveJson(token, `Delete ${fileName} from photos.json`, window.allPhotos);
                
                // 2. ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ
                const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                if (fileRes.ok) {
                    const fileData = await fileRes.json();
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "DELETE",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Delete file: ${fileName}`, sha: fileData.sha })
                    });
                }
                alert("ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadPhotoList();
            } catch(e) { alert("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: " + e.message); }
        }

        // [6] ì‹ ê·œ ì‚¬ì§„ ì—…ë¡œë“œ ë¡œì§
        async function handleUpload() {
            const token = document.getElementById('token').value;
            const fileInput = document.getElementById('fileInput').files[0];
            const info = document.getElementById('photoInfo').value;
            const date = document.getElementById('photoDate').value;
            const status = document.getElementById('status');
            
            if (!token || !fileInput) return alert("í† í°ê³¼ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");
            if (!date) return alert("ì´¬ì˜ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            
            status.innerText = "â³ ì´ë¯¸ì§€ ìµœì í™” ì¤‘...";
            try {
                const optimizedBlob = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.readAsDataURL(fileInput);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > 1920) { h = (1920 * h) / w; w = 1920; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
                        };
                    };
                });

                const reader = new FileReader();
                reader.readAsDataURL(optimizedBlob);
                reader.onload = async () => {
                    const content = reader.result.split(',')[1];
                    const fileName = fileInput.name.replace(/\.[^/.]+$/, "") + "_" + Date.now() + ".jpg";
                    
                    status.innerText = "ğŸ“¤ ê¹ƒí—ˆë¸Œë¡œ ì „ì†¡ ì¤‘...";
                    
                    // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Upload: ${fileName}`, content: content })
                    });
                    
                    // 2. JSONì— ë°ì´í„° ì¶”ê°€ (ë‚ ì§œ í¬í•¨)
                    const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                        headers: { "Authorization": `token ${token}` } 
                    });
                    const fileData = await res.json();
                    const photos = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                    
                    photos.push({ filename: fileName, info: info, date: date });
                    
                    await saveJson(token, `Add ${fileName} (${date})`, photos);
                    
                    status.innerText = "âœ… ì—…ë¡œë“œ ì„±ê³µ!";
                    loadPhotoList();
                };
            } catch (e) { status.innerText = "âŒ ì‹¤íŒ¨: " + e.message; }
        }
    </script>
</body>
</html>
