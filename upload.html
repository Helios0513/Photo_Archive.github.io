<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ì¼ê´„ ë‚ ì§œ ìˆ˜ì •)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; display: block; font-weight: bold; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; }
        .info-msg { font-size: 0.8rem; color: #666; margin-bottom: 15px; text-align: center; }
        
        .manage-section { max-width: 600px; margin: 50px auto; font-family: sans-serif; }
        
        /* ì¼ê´„ ì €ì¥ ë°” ìŠ¤íƒ€ì¼ */
        .batch-action-bar {
            position: sticky; top: 10px; z-index: 100;
            background: #f0f7ff; padding: 15px; border: 2px solid #007bff; 
            border-radius: 10px; margin-bottom: 20px; display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .batch-btn { background-color: #007bff; margin: 0; }

        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #f9f9f9; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .btn-group { display: flex; gap: 5px; }
        .btn-group button { width: auto; padding: 6px 12px; font-size: 0.75rem; margin-bottom: 0; }
        .delete-btn { background-color: #dc3545; }
        .refresh-btn { background-color: #6c757d; margin-bottom: 10px; width: 100%; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ìƒˆ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h2>
        <p class="info-msg">ì‚¬ì§„ì„ ì„ íƒí•˜ë©´ ì´¬ì˜ ì •ë³´ì™€ ë‚ ì§œë¥¼ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        <input type="file" id="fileInput" accept="image/*">
        <label for="photoDate">ğŸ“… ì´¬ì˜ ë‚ ì§œ í™•ì¸/ìˆ˜ì •</label>
        <input type="date" id="photoDate">
        <label for="photoInfo">ğŸ“ ì‚¬ì§„ ìƒì„¸ ì •ë³´</label>
        <textarea id="photoInfo" rows="3" placeholder="ì¹´ë©”ë¼ ì •ë³´ê°€ ì—¬ê¸°ì— ì…ë ¥ë©ë‹ˆë‹¤."></textarea>
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ê´€ë¦¬</h2>
        <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° / ìƒˆë¡œê³ ì¹¨</button>
        
        <div id="batchBar" class="batch-action-bar">
            <div style="flex:1; font-size: 0.85rem;"><strong>ğŸ’¡ í¸ì§‘ ëª¨ë“œ:</strong> ë‚ ì§œ/ì •ë³´ë¥¼ ìˆ˜ì •í•œ í›„ ì €ì¥í•˜ì„¸ìš”.</div>
            <button class="batch-btn" onclick="saveAllChanges()">âœ… ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥</button>
        </div>

        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ [ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        // [1] EXIF ì¶”ì¶œ (ê¸°ì¡´ ìœ ì§€)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            EXIF.getData(file, function() {
                const model = EXIF.getTag(this, "Model") || "Unknown Camera";
                const fl = EXIF.getTag(this, "FocalLength");
                const fn = EXIF.getTag(this, "FNumber");
                const et = EXIF.getTag(this, "ExposureTime");
                const iso = EXIF.getTag(this, "ISOSpeedRatings");
                const focal = fl ? Math.round(fl) + "mm" : "";
                let shutter = et < 1 ? `1/${Math.round(1/et)}` : (et ? Math.round(et * 10) / 10 : "");
                const fVal = fn ? `f${Math.round(fn * 10) / 10}` : "";
                document.getElementById('photoInfo').value = `${model} ${focal} ${fVal}, ${shutter}s iso ${iso}`;
                const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                if (exifDate) {
                    const parts = exifDate.split(" ")[0].split(":");
                    document.getElementById('photoDate').value = `${parts[0]}-${parts[1]}-${parts[2]}`;
                } else {
                    document.getElementById('photoDate').value = new Date().toISOString().substring(0, 10);
                }
            });
        });

        // [2] ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "<p style='text-align:center;'>ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>";
            
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                const data = await res.json();
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                document.getElementById('batchBar').style.display = 'flex';
                renderList();
            } catch (e) { listDiv.innerHTML = "âŒ ë¡œë“œ ì‹¤íŒ¨: " + e.message; }
        }

        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="images/digital/${p.filename}">
                    <div class="photo-info-edit">
                        <input type="date" class="edit-date" data-index="${realIndex}" value="${p.date || ''}">
                        <input type="text" class="edit-info" data-index="${realIndex}" value="${p.info}">
                        <small>${p.filename}</small>
                    </div>
                    <div class="btn-group">
                        <button class="delete-btn" onclick="deletePhoto(${realIndex}, '${p.filename}')">ì‚­ì œ</button>
                    </div>
                `;
                listDiv.appendChild(item);
            });
        }

        // [3] âœ¨ ì‹ ê·œ: ì¼ê´„ ì €ì¥ ê¸°ëŠ¥
        async function saveAllChanges() {
            const token = document.getElementById('token').value;
            if(!confirm("ì…ë ¥í•œ ëª¨ë“  ë‚ ì§œì™€ ì •ë³´ë¥¼ í•œ ë²ˆì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            // í˜„ì¬ í™”ë©´ì˜ ì…ë ¥ê°’ë“¤ì„ ì‹¤ì œ ë°ì´í„° ë°°ì—´(allPhotos)ì— ë°˜ì˜
            const dateInputs = document.querySelectorAll('.edit-date');
            const infoInputs = document.querySelectorAll('.edit-info');

            dateInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].date = input.value;
            });
            infoInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].info = input.value;
            });

            try {
                document.getElementById('status').innerText = "â³ ì „ì²´ ë°ì´í„° ì¼ê´„ ì €ì¥ ì¤‘...";
                await saveJson(token, "Batch update photo dates and info", window.allPhotos);
                alert("ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadPhotoList();
            } catch(e) { alert("ì¼ê´„ ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        }

        // [4] ê³µí†µ JSON ì €ì¥ ë¡œì§
        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                headers: { "Authorization": `token ${token}` } 
            });
            const fileData = await res.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
        }

        // [5] ì‚¬ì§„ ì‚­ì œ ë¡œì§
        async function deletePhoto(index, fileName) {
            const token = document.getElementById('token').value;
            if(!confirm("ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            window.allPhotos.splice(index, 1);
            try {
                await saveJson(token, `Delete ${fileName}`, window.allPhotos);
                const fileRes = await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                if (fileRes.ok) {
                    const fileData = await fileRes.json();
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "DELETE",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Delete file: ${fileName}`, sha: fileData.sha })
                    });
                }
                alert("ì‚­ì œ ì™„ë£Œ.");
                loadPhotoList();
            } catch(e) { }
        }

        // [6] ì—…ë¡œë“œ ë¡œì§
        async function handleUpload() {
            const token = document.getElementById('token').value;
            const fileInput = document.getElementById('fileInput').files[0];
            const info = document.getElementById('photoInfo').value;
            const date = document.getElementById('photoDate').value;
            if (!token || !fileInput || !date) return alert("í† í°, íŒŒì¼, ë‚ ì§œë¥¼ ëª¨ë‘ í™•ì¸í•´ì£¼ì„¸ìš”!");
            
            const status = document.getElementById('status');
            status.innerText = "â³ ì—…ë¡œë“œ ì¤‘...";
            
            try {
                const optimizedBlob = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.readAsDataURL(fileInput);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if (w > 1920) { h = (1920 * h) / w; w = 1920; }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.85);
                        };
                    };
                });

                const reader = new FileReader();
                reader.readAsDataURL(optimizedBlob);
                reader.onload = async () => {
                    const content = reader.result.split(',')[1];
                    const fileName = fileInput.name.replace(/\.[^/.]+$/, "") + "_" + Date.now() + ".jpg";
                    
                    await fetch(`https://api.github.com/repos/${repo}/contents/images/digital/${fileName}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}` },
                        body: JSON.stringify({ message: `Upload: ${fileName}`, content: content })
                    });
                    
                    const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                        headers: { "Authorization": `token ${token}` } 
                    });
                    const fileData = await res.json();
                    const photos = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                    photos.push({ filename: fileName, info: info, date: date });
                    
                    await saveJson(token, `Add ${fileName}`, photos);
                    status.innerText = "âœ… ì—…ë¡œë“œ ì„±ê³µ!";
                    loadPhotoList();
                };
            } catch (e) { status.innerText = "âŒ ì‹¤íŒ¨: " + e.message; }
        }
    </script>
</body>
</html>
