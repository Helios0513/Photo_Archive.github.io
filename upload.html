<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì§„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ (ì¼ê´„ ë‚ ì§œ ë³µêµ¬ ê¸°ëŠ¥)</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .upload-box { max-width: 600px; margin: 30px auto; padding: 20px; border: 1px solid #ddd; border-radius: 10px; font-family: sans-serif; background: white; }
        input, button, textarea { width: 100%; margin-bottom: 10px; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        label { font-size: 0.85rem; color: #555; margin-bottom: 5px; display: block; font-weight: bold; }
        button { background-color: #333; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #555; }
        #status { color: blue; font-weight: bold; text-align: center; margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem; }
        
        .manage-section { max-width: 600px; margin: 50px auto; font-family: sans-serif; }
        
        /* âœ¨ ì¼ê´„ ë„êµ¬ ìƒì */
        .batch-tool-box { 
            background: #fff4e5; padding: 15px; border: 2px solid #ff9800; 
            border-radius: 10px; margin-bottom: 20px; display: none;
        }
        .batch-tool-box h3 { margin-top: 0; font-size: 1rem; color: #e65100; }
        .magic-btn { background-color: #ff9800; margin-top: 5px; }
        .save-all-btn { background-color: #28a745; margin-top: 10px; }

        .photo-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; background: #fff; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee; }
        .photo-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; background: #f9f9f9; }
        .photo-info-edit { flex-grow: 1; }
        .photo-info-edit input { margin-bottom: 5px; padding: 8px; font-size: 0.85rem; width: 100%; }
        .delete-btn { background-color: #dc3545; width: auto; padding: 6px 12px; font-size: 0.75rem; }
        .refresh-btn { background-color: #007bff; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="upload-box">
        <h2>ğŸ“· ìƒˆ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</h2>
        <input type="password" id="token" placeholder="ê¹ƒí—ˆë¸Œ í† í° ì…ë ¥">
        <input type="file" id="fileInput" accept="image/*">
        <label>ğŸ“… ì´¬ì˜ ë‚ ì§œ í™•ì¸</label>
        <input type="date" id="photoDate">
        <label>ğŸ“ ì‚¬ì§„ ìƒì„¸ ì •ë³´</label>
        <textarea id="photoInfo" rows="3"></textarea>
        <button onclick="handleUpload()">ì—…ë¡œë“œ ì‹œì‘</button>
        <div id="status"></div>
    </div>

    <div class="manage-section">
        <h2>ğŸ“‚ ê¸°ì¡´ ì‚¬ì§„ ê´€ë¦¬ ë° ë³µêµ¬</h2>
        <button class="refresh-btn" onclick="loadPhotoList()">ğŸ”„ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        
        <div id="batchTool" class="batch-tool-box">
            <h3>ğŸ›  ì¼ê´„ ë‚ ì§œ ë³µêµ¬ ë„êµ¬</h3>
            <p style="font-size: 0.8rem; color: #666;">
                ë‚ ì§œê°€ ì—†ëŠ” ê¸°ì¡´ ì‚¬ì§„ë“¤ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ìë™ìœ¼ë¡œ ë‚ ì§œë¥¼ ì±„ì›ë‹ˆë‹¤.
            </p>
            <button class="magic-btn" onclick="autoFillDates()">ğŸª„ ê¸°ì¡´ ì‚¬ì§„ ë‚ ì§œ ì¼ê´„ ì¶”ì¶œí•˜ê¸°</button>
            <button class="save-all-btn" onclick="saveAllChanges()">âœ… ë³€ê²½ëœ ëª¨ë“  ë‚´ìš© ì €ì¥í•˜ê¸°</button>
        </div>

        <div id="photoList">
            <p style="text-align: center; color: #999;">í† í° ì…ë ¥ í›„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const repo = "Helios0513/Photo_Archive.github.io";

        // [1] EXIF ì¶”ì¶œ (ì‹ ê·œ ì—…ë¡œë“œìš©)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            EXIF.getData(file, function() {
                const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                if (exifDate) {
                    const parts = exifDate.split(" ")[0].split(":");
                    document.getElementById('photoDate').value = `${parts[0]}-${parts[1]}-${parts[2]}`;
                }
                // (ì¹´ë©”ë¼ ì •ë³´ ë¡œì§ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼)
            });
        });

        // [2] ëª©ë¡ ë¡œë“œ
        async function loadPhotoList() {
            const token = document.getElementById('token').value;
            if (!token) return alert("í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                    headers: { "Authorization": `token ${token}` } 
                });
                const data = await res.json();
                window.allPhotos = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                document.getElementById('batchTool').style.display = 'block';
                renderList();
            } catch (e) { alert("ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function renderList() {
            const listDiv = document.getElementById('photoList');
            listDiv.innerHTML = "";
            window.allPhotos.slice().reverse().forEach((p, index) => {
                const realIndex = window.allPhotos.length - 1 - index;
                const item = document.createElement('div');
                item.className = 'photo-item';
                item.innerHTML = `
                    <img src="images/digital/${p.filename}" id="img-${realIndex}">
                    <div class="photo-info-edit">
                        <input type="date" class="edit-date" data-index="${realIndex}" value="${p.date || ''}">
                        <input type="text" class="edit-info" data-index="${realIndex}" value="${p.info}">
                        <small>${p.filename}</small>
                    </div>
                    <button class="delete-btn" onclick="deletePhoto(${realIndex}, '${p.filename}')">ì‚­ì œ</button>
                `;
                listDiv.appendChild(item);
            });
        }

        // [3] âœ¨ ì‹ ê·œ: ê¸°ì¡´ ì‚¬ì§„ ë‚ ì§œ ì¼ê´„ ì¶”ì¶œ ë²„íŠ¼ ê¸°ëŠ¥
        async function autoFillDates() {
            const status = document.getElementById('status');
            const dateInputs = document.querySelectorAll('.edit-date');
            let count = 0;

            status.innerText = "â³ ê¸°ì¡´ ì‚¬ì§„ ë¶„ì„ ì‹œì‘ (ì‹œê°„ì´ ë‹¤ì†Œ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)...";

            for (let input of dateInputs) {
                if (!input.value) { // ë‚ ì§œê°€ ë¹„ì–´ìˆëŠ” í•­ëª©ë§Œ ì²˜ë¦¬
                    const idx = input.getAttribute('data-index');
                    const fileName = window.allPhotos[idx].filename;
                    const imgUrl = `images/digital/${fileName}`;

                    try {
                        // ì´ë¯¸ì§€ íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ EXIF ë¶„ì„
                        const response = await fetch(imgUrl);
                        const blob = await response.blob();
                        
                        await new Promise((resolve) => {
                            EXIF.getData(blob, function() {
                                const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                                if (exifDate) {
                                    const parts = exifDate.split(" ")[0].split(":");
                                    const formattedDate = `${parts[0]}-${parts[1]}-${parts[2]}`;
                                    input.value = formattedDate;
                                    input.style.border = "2px solid #ff9800"; // ë³µêµ¬ëœ í•­ëª© í‘œì‹œ
                                    count++;
                                }
                                resolve();
                            });
                        });
                    } catch (err) {
                        console.log(`${fileName} ì¶”ì¶œ ì‹¤íŒ¨:`, err);
                    }
                }
            }
            status.innerText = `âœ… ë¶„ì„ ì™„ë£Œ! ${count}ê°œì˜ ë‚ ì§œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤. \n ë°˜ë“œì‹œ í•˜ë‹¨ì˜ [ë³€ê²½ì‚¬í•­ ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
        }

        // [4] ì¼ê´„ ì €ì¥
        async function saveAllChanges() {
            const token = document.getElementById('token').value;
            const dateInputs = document.querySelectorAll('.edit-date');
            const infoInputs = document.querySelectorAll('.edit-info');

            dateInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].date = input.value;
            });
            infoInputs.forEach(input => {
                const idx = input.getAttribute('data-index');
                window.allPhotos[idx].info = input.value;
            });

            try {
                await saveJson(token, "Batch update photo dates from metadata", window.allPhotos);
                alert("ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì¥ë¶€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                loadPhotoList();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        }

        // [5] ì €ì¥ ë¡œì§ (SHA ê°±ì‹  í¬í•¨)
        async function saveJson(token, msg, data) {
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, { 
                headers: { "Authorization": `token ${token}` } 
            });
            const fileData = await res.json();
            await fetch(`https://api.github.com/repos/${repo}/contents/photos.json`, {
                method: "PUT",
                headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))),
                    sha: fileData.sha
                })
            });
        }

        // (ì‚­ì œ ë° ì‹ ê·œ ì—…ë¡œë“œ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤)
        // ... (deletePhoto, handleUpload í•¨ìˆ˜)
    </script>
</body>
</html>
